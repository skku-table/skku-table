name: CD â€“ Deploy Front- and Back-end to Oracle Cloud

on:
  workflow_run:
    workflows: ["CI - PR & Main build"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion != 'skipped' && github.event.workflow_run.head_branch == 'main'}}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4 # ì›Œí¬í”Œë¡œ íŒŒì¼ì´ ë“¤ì–´ ìˆëŠ” ë ˆí¬ ì²´í¬ì•„ì›ƒ

      # webfactory/ssh-agent ë‹¨ê³„ëŠ” appleboy/ssh-actionì´ í‚¤ë¥¼ ì§ì ‘ ì²˜ë¦¬í•˜ë¯€ë¡œ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

      - name: Deploy to Oracle Cloud - Pull latest and set up .env
        uses: appleboy/ssh-action@v1.2.2 # ë˜ëŠ” ìµœì‹  ë²„ì „ì„ ìœ„í•´ @v1 ì‚¬ìš© ê°€ëŠ¥
        # ì´ env ë¸”ë¡ì€ GitHub Actions ìŠ¤í… ìì²´ì˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        # ì—¬ê¸°ì„œ ì„¤ì •ëœ SCRIPT_NEXT_PUBLIC_API_URL ë³€ìˆ˜ë¥¼ 'with.envs'ë¥¼ í†µí•´ ì›ê²© ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        env:
          SCRIPT_NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
        with:
          host: skkutable.com # ì§ì ‘ ê°’ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ${{ env.HOST }} ì™€ ê°™ì´ job/workflow ë ˆë²¨ì—ì„œ HOST í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥
          username: ubuntu # ì§ì ‘ ê°’ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ${{ env.USER }} ì™€ ê°™ì´ job/workflow ë ˆë²¨ì—ì„œ USER í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          port: 22 # ê¸°ë³¸ê°’ì´ 22ì´ë¯€ë¡œ ëª…ì‹œí•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ë‹¤ë¥¸ í¬íŠ¸ì¸ ê²½ìš° ì§€ì •í•©ë‹ˆë‹¤.
          envs: SCRIPT_NEXT_PUBLIC_API_URL # ì—¬ê¸°ì— ëª…ì‹œëœ ë³€ìˆ˜ë“¤ì´ ì›ê²© ì‰˜ì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
          script: |
            set -ex  # ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì‹¤í–‰ë˜ëŠ” ëª…ë ¹ì–´ë“¤ì„ ì¶œë ¥í•©ë‹ˆë‹¤.

            echo "ğŸ”„ Pulling latest repository changes and setting up .env file..."
            cd ~  # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™

            # skku-table ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° git ì‘ì—…
            if [ ! -d skku-table ]; then
              echo "Cloning skku-table repository..."
              git clone https://github.com/skku-table/skku-table.git
            else
              echo "Found skku-table directory, pulling latest changes..."
              cd skku-table
              git pull
              cd ..
            fi

            echo "Navigating to skku-table/frontend/ to create .env.production..."
            cd skku-table/frontend/

            # .env.production íŒŒì¼ ìƒì„±
            echo "NEXT_PUBLIC_API_URL=$SCRIPT_NEXT_PUBLIC_API_URL" > .env.production
            echo ".env.production file created/updated successfully."

            cd ~ # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            echo "âœ… Script part 1 (pull & .env setup) finished."

      - name: Deploy application using Docker Compose on Oracle Cloud
        uses: appleboy/ssh-action@v1.2.2 # ë˜ëŠ” ìµœì‹  ë²„ì „ì„ ìœ„í•´ @v1 ì‚¬ìš© ê°€ëŠ¥
        with:
          host: skkutable.com # ìœ„ì™€ ë™ì¼í•œ í˜¸ìŠ¤íŠ¸ ì •ë³´
          username: ubuntu # ìœ„ì™€ ë™ì¼í•œ ì‚¬ìš©ì ì •ë³´
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          port: 22 # ê¸°ë³¸ê°’
          script: |
            set -ex # ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì‹¤í–‰ë˜ëŠ” ëª…ë ¹ì–´ë“¤ì„ ì¶œë ¥í•©ë‹ˆë‹¤.

            echo "â™»ï¸ Running docker-compose pull and up..."
            cd ~/skku-table # skku-table ë””ë ‰í† ë¦¬ë¡œ ì´ë™

            echo "Pulling latest Docker images..."
            docker compose pull

            echo "Starting application with docker-compose up -d..."
            docker compose up -d --remove-orphans #å­¤ç«‹ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤

            echo "âœ… Docker Compose deployment finished."

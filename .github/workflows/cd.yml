name: CD â€“ Deploy Front- and Back-end to Oracle Cloud

on:
  workflow_run: # 'CI - PR & Main build' ì›Œí¬í”Œë¡œìš°ë¥¼ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•œ íŠ¸ë¦¬ê±°
    workflows: ["CI - PR & Main build"] # ci.yml íŒŒì¼ì— ì •ì˜ëœ nameê³¼ ì •í™•ížˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    types: [completed] # 'CI - PR & Main build'ê°€ ì™„ë£Œë˜ì—ˆì„ ë•Œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.

jobs:
  deploy:
    # "CI - PR & Main build" ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4 # ì›Œí¬í”Œë¡œ íŒŒì¼ì´ ë“¤ì–´ ìžˆëŠ” ë ˆí¬ ì²´í¬ì•„ì›ƒ

      # webfactory/ssh-agent ë‹¨ê³„ëŠ” appleboy/ssh-actionì´ í‚¤ë¥¼ ì§ì ‘ ì²˜ë¦¬í•˜ë¯€ë¡œ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

      - name: Deploy to Oracle Cloud - Pull latest and set up .env
        uses: appleboy/ssh-action@v1.2.2 # ë˜ëŠ” ìµœì‹  ë²„ì „ì„ ìœ„í•´ @v1 ì‚¬ìš© ê°€ëŠ¥
        # ì´ env ë¸”ë¡ì€ GitHub Actions ìŠ¤í… ìžì²´ì˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        # ì—¬ê¸°ì„œ ì„¤ì •ëœ SCRIPT_NEXT_PUBLIC_API_URL ë³€ìˆ˜ë¥¼ 'with.envs'ë¥¼ í†µí•´ ì›ê²© ìŠ¤í¬ë¦½íŠ¸ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        env:
          SCRIPT_NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
          SCRIPT_NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
          SCRIPT_NEXT_PUBLIC_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN }}
          SCRIPT_NEXT_PUBLIC_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROJECT_ID }}
          SCRIPT_NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }}
          SCRIPT_NEXT_PUBLIC_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID }}
          SCRIPT_NEXT_PUBLIC_APP_ID: ${{ secrets.NEXT_PUBLIC_APP_ID }}
          SCRIPT_NEXT_PUBLIC_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_MEASUREMENT_ID }}
        with:
          host: skkutable.com # ì§ì ‘ ê°’ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ${{ env.HOST }} ì™€ ê°™ì´ job/workflow ë ˆë²¨ì—ì„œ HOST í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥
          username: ubuntu # ì§ì ‘ ê°’ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ${{ env.USER }} ì™€ ê°™ì´ job/workflow ë ˆë²¨ì—ì„œ USER í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          port: 22 # ê¸°ë³¸ê°’ì´ 22ì´ë¯€ë¡œ ëª…ì‹œí•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ë‹¤ë¥¸ í¬íŠ¸ì¸ ê²½ìš° ì§€ì •í•©ë‹ˆë‹¤.
          envs: SCRIPT_NEXT_PUBLIC_API_URL,SCRIPT_NEXT_PUBLIC_API_KEY,SCRIPT_NEXT_PUBLIC_AUTH_DOMAIN,SCRIPT_NEXT_PUBLIC_PROJECT_ID,SCRIPT_NEXT_PUBLIC_STORAGE_BUCKET,SCRIPT_NEXT_PUBLIC_MESSAGING_SENDER_ID,SCRIPT_NEXT_PUBLIC_APP_ID,SCRIPT_NEXT_PUBLIC_MEASUREMENT_ID # ì—¬ê¸°ì— ëª…ì‹œëœ ë³€ìˆ˜ë“¤ì´ ì›ê²© ì‰˜ì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
          script: |
            set -ex  # ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì‹¤í–‰ë˜ëŠ” ëª…ë ¹ì–´ë“¤ì„ ì¶œë ¥í•©ë‹ˆë‹¤.

            echo "ðŸ”„ Pulling latest repository changes and setting up .env file..."
            cd ~  # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™

            # skku-table ë””ë ‰í† ë¦¬ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ë° git ìž‘ì—…
            if [ ! -d skku-table ]; then
              echo "Cloning skku-table repository..."
              git clone https://github.com/skku-table/skku-table.git
            else
              echo "Found skku-table directory, pulling latest changes..."
              cd skku-table
              git pull
              cd ..
            fi

            echo "Navigating to skku-table/frontend/ to create .env.production..."
            cd skku-table/frontend/

            # .env.production íŒŒì¼ ìƒì„±
            echo "NEXT_PUBLIC_API_URL=$SCRIPT_NEXT_PUBLIC_API_URL" > .env.production
            echo "NEXT_PUBLIC_API_KEY=$SCRIPT_NEXT_PUBLIC_API_KEY" >> .env.production
            echo "NEXT_PUBLIC_AUTH_DOMAIN=$SCRIPT_NEXT_PUBLIC_AUTH_DOMAIN" >> .env.production
            echo "NEXT_PUBLIC_PROJECT_ID=$SCRIPT_NEXT_PUBLIC_PROJECT_ID" >> .env.production
            echo "NEXT_PUBLIC_STORAGE_BUCKET=$SCRIPT_NEXT_PUBLIC_STORAGE_BUCKET" >> .env.production
            echo "NEXT_PUBLIC_MESSAGING_SENDER_ID=$SCRIPT_NEXT_PUBLIC_MESSAGING_SENDER_ID" >> .env.production
            echo "NEXT_PUBLIC_APP_ID=$SCRIPT_NEXT_PUBLIC_APP_ID" >> .env.production
            echo "NEXT_PUBLIC_MEASUREMENT_ID=$SCRIPT_NEXT_PUBLIC_MEASUREMENT_ID" >> .env.production
            echo ".env.production file created/updated successfully."

            cd ~ # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            echo "âœ… Script part 1 (pull & .env setup) finished."

      - name: Deploy application using Docker Compose on Oracle Cloud
        uses: appleboy/ssh-action@v1.2.2 # ë˜ëŠ” ìµœì‹  ë²„ì „ì„ ìœ„í•´ @v1 ì‚¬ìš© ê°€ëŠ¥
        env:
          SCRIPT_CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          SCRIPT_CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          SCRIPT_CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          SCRIPT_MYSQL_DATABASE: skku-table-prod # í”„ë¡œë•ì…˜ ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
          SCRIPT_MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          SCRIPT_SPRING_DATASOURCE_URL: jdbc:mysql://database:3306/skku-table-prod?allowPublicKeyRetrieval=true&useSSL=false
          SCRIPT_SPRING_PROFILES_ACTIVE: prod # í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì •
          SCRIPT_FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        with:
          host: skkutable.com # ìœ„ì™€ ë™ì¼í•œ í˜¸ìŠ¤íŠ¸ ì •ë³´
          username: ubuntu # ìœ„ì™€ ë™ì¼í•œ ì‚¬ìš©ìž ì •ë³´
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          port: 22 # ê¸°ë³¸ê°’
          envs: SCRIPT_CLOUDINARY_API_KEY,SCRIPT_CLOUDINARY_API_SECRET,SCRIPT_CLOUDINARY_CLOUD_NAME,SCRIPT_MYSQL_DATABASE,SCRIPT_MYSQL_ROOT_PASSWORD,SCRIPT_SPRING_DATASOURCE_URL,SCRIPT_SPRING_PROFILES_ACTIVE,SCRIPT_FIREBASE_SERVICE_ACCOUNT_KEY
          script: |
            set -ex # ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì‹¤í–‰ë˜ëŠ” ëª…ë ¹ì–´ë“¤ì„ ì¶œë ¥í•©ë‹ˆë‹¤.

            echo "â™»ï¸ Running docker-compose pull and up..."
            cd ~/skku-table # skku-table ë””ë ‰í† ë¦¬ë¡œ ì´ë™

            # .env íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ìƒì„±
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              echo "CLOUDINARY_CLOUD_NAME=$SCRIPT_CLOUDINARY_CLOUD_NAME" >> .env
              echo "CLOUDINARY_API_KEY=$SCRIPT_CLOUDINARY_API_KEY" >> .env
              echo "CLOUDINARY_API_SECRET=$SCRIPT_CLOUDINARY_API_SECRET" >> .env
              echo "MYSQL_DATABASE=$SCRIPT_MYSQL_DATABASE" >> .env
              echo "MYSQL_ROOT_PASSWORD=$SCRIPT_MYSQL_ROOT_PASSWORD" >> .env
              echo "SPRING_DATASOURCE_URL=$SCRIPT_SPRING_DATASOURCE_URL" >> .env
              echo "SPRING_PROFILES_ACTIVE=$SCRIPT_SPRING_PROFILES_ACTIVE" >> .env
              echo "FIREBASE_SERVICE_ACCOUNT_KEY=$SCRIPT_FIREBASE_SERVICE_ACCOUNT_KEY" >> .env
            else
              echo ".env file already exists, skipping creation."
            fi
            echo "Pulling latest Docker images..."
            docker compose pull

            echo "Starting application with docker-compose up -d..."
            docker compose up -d --build --remove-orphans

            echo "âœ… Docker Compose deployment finished."
